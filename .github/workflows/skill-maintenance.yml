name: Skill Maintenance

on:
  schedule:
    - cron: '0 6 1,15 * *' # 1st and 15th of month at 6am UTC
  workflow_dispatch:
    inputs:
      skill:
        description: "Run for specific skill (or 'all')"
        required: false
        default: all
        type: choice
        options:
          - all
          - vue
          - nuxt
          - nuxthub
          - nuxt-content
          - nuxt-ui
          - nuxt-better-auth
          - nuxt-modules
          - reka-ui
          - vitest
          - vite
          - pnpm
          - tsdown

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  check-updates:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - skill: vue
            upstream: |
              - GitHub: hyf0/vue-skills (PRIORITY - our rules are based on this repo)
              - GitHub: vuejs/core (releases, changelog)
              - Docs: https://vuejs.org/guide/introduction.html
              - VueUse: https://vueuse.org/ (new composables)
            focus: 'Composition API, reactivity, VueUse composables, defineModel, reactive destructuring, patterns from hyf0/vue-skills'

          - skill: nuxt
            upstream: |
              - GitHub: nuxt/nuxt (releases, changelog)
              - Docs: https://nuxt.com/docs
              - h3: https://h3.unjs.io/ (server engine)
              - Nitro: https://nitro.unjs.io/
            focus: 'Nuxt 4 patterns, server routes, file-based routing, composables, config changes'

          - skill: nuxthub
            upstream: |
              - GitHub: nuxt-hub/core (releases, changelog)
              - Docs: https://hub.nuxt.com/docs
              - Migration: https://hub.nuxt.com/docs/getting-started/migration
            focus: 'v0.10 APIs, hub:db/kv/blob imports, Drizzle ORM, multi-cloud deployment, deprecated features'

          - skill: nuxt-content
            upstream: |
              - GitHub: nuxt/content (releases, changelog)
              - Docs: https://content.nuxt.com/
            focus: 'MDC syntax, content collections, query API, rendering'

          - skill: nuxt-ui
            upstream: |
              - GitHub: nuxt/ui (releases, changelog)
              - Docs: https://ui.nuxt.com/
            focus: 'Component props, theming, new components, breaking changes'

          - skill: nuxt-better-auth
            upstream: |
              - GitHub: onmax/nuxt-better-auth (releases)
              - Better Auth: https://www.better-auth.com/ (core library)
            focus: 'Module config, composables, server helpers, plugins integration'

          - skill: nuxt-modules
            upstream: |
              - Docs: https://nuxt.com/docs/guide/going-further/modules
              - Kit: https://nuxt.com/docs/api/kit
            focus: 'Module authoring, hooks, runtime vs build, kit utilities'

          - skill: reka-ui
            upstream: |
              - GitHub: unovue/reka-ui (releases, changelog)
              - Docs: https://reka-ui.com/
            focus: 'Component APIs, props/emits/slots, new components, accessibility'

          - skill: vitest
            upstream: |
              - GitHub: antfu/skills (SYNCED - primary source)
              - GitHub: vitest-dev/vitest (releases, changelog)
              - Docs: https://vitest.dev/
            focus: 'Test API, mocking, coverage, type testing, config options'

          - skill: vite
            upstream: |
              - GitHub: antfu/skills (SYNCED - primary source)
              - GitHub: vitejs/vite (releases, changelog)
              - Docs: https://vite.dev/
            focus: 'Config, plugins, HMR, build modes, SSR, library mode'

          - skill: pnpm
            upstream: |
              - GitHub: antfu/skills (SYNCED - primary source)
              - GitHub: pnpm/pnpm (releases, changelog)
              - Docs: https://pnpm.io/
            focus: 'Workspaces, catalogs, CLI commands, CI/CD patterns'

          - skill: tsdown
            upstream: |
              - GitHub: antfu/skills (SYNCED - primary source)
              - GitHub: rolldown/tsdown (releases, changelog)
              - Docs: https://tsdown.dev/
            focus: 'Config, DTS generation, output formats, plugins'

    steps:
      - name: Skip if not matching manual input
        if: github.event.inputs.skill != '' && github.event.inputs.skill != 'all' && github.event.inputs.skill != matrix.skill
        run: echo "Skipping ${{ matrix.skill }} - not selected" && exit 0

      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          model: claude-sonnet-4-20250514
          timeout_minutes: 15
          prompt: |
            SKILL: ${{ matrix.skill }}
            SKILL_PATH: skills/${{ matrix.skill }}/
            UPSTREAM_SOURCES:
            ${{ matrix.upstream }}
            FOCUS_AREAS: ${{ matrix.focus }}

            ## Task
            Check if the skill needs updates based on upstream changes.

            ## Steps

            1. **Read current skill content**
               - Read skills/${{ matrix.skill }}/SKILL.md
               - Read all files in skills/${{ matrix.skill }}/references/

            2. **Check upstream sources**
               - Fetch changelogs/releases from GitHub repos listed above
               - Check official docs for new features, deprecations, breaking changes
               - Focus on the areas listed in FOCUS_AREAS

            3. **Compare and analyze**
               - What's new upstream that we don't cover?
               - What's deprecated/changed that we still document incorrectly?
               - Are our examples still accurate?
               - Are there new best practices we should adopt?

            4. **If updates needed, create a PR**
               - Create a new branch: update-${{ matrix.skill }}-YYYYMMDD
               - Update the skill following the CLAUDE.md guidelines
               - Use progressive loading pattern (main SKILL.md ~300 tokens)
               - Update references/*.md files as needed
               - Commit with message: "chore(${{ matrix.skill }}): sync with upstream"
               - Create PR with summary of changes

            5. **If no updates needed**
               - Just output "No updates needed for ${{ matrix.skill }}"

            ## Important Guidelines

            - Follow CLAUDE.md checklist when editing skills
            - Keep progressive loading pattern (small SKILL.md, detailed references)
            - Don't add features that don't exist upstream
            - Mark alpha/experimental features clearly
            - Include version info when relevant

          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,WebFetch,Bash(git:*),Bash(gh:*),Bash(curl:*)"

  # Track antfu/skills for new skills or major rewrites
  sync-antfu-skills:
    runs-on: ubuntu-latest
    if: github.event.inputs.skill == '' || github.event.inputs.skill == 'all'
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Clone antfu/skills
        run: git clone --depth 1 https://github.com/antfu/skills.git /tmp/antfu-skills

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          model: claude-sonnet-4-20250514
          timeout_minutes: 20
          prompt: |
            ## Task
            Sync skills from antfu/skills upstream repository.

            **Our skills from antfu/skills:** vitest, vite, pnpm, tsdown

            ## Steps

            1. **Check for new skills in antfu/skills**
               - List skills in /tmp/antfu-skills/skills/
               - Compare with our skills/ directory
               - Identify any NEW skills we don't have (exclude: vue, nuxt, antfu, slidev, turborepo, unocss, vitepress, vue-best-practices, vueuse, web-design-guidelines - we have our own or don't need)

            2. **Check for updates in synced skills**
               For each of: vitest, vite, pnpm, tsdown
               - Compare /tmp/antfu-skills/skills/{skill}/ with skills/{skill}/
               - Check if SKILL.md structure changed significantly
               - Check if new reference files were added
               - Check if existing references have major updates

            3. **If changes found, create PR**
               - Branch: sync-antfu-skills-YYYYMMDD
               - Copy new/updated files (skip GENERATION.md files)
               - Update marketplace.json if new skills added
               - Update README.md if new skills added
               - Commit: "chore: sync with antfu/skills upstream"
               - Create PR with detailed changelog

            4. **If no changes needed**
               - Output "antfu/skills is in sync"

            ## Important
            - Do NOT copy GENERATION.md files
            - Keep our SKILL.md descriptions if they're better suited for our audience
            - Update the upstream tracking comment in synced SKILL.md files
          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(git:*),Bash(gh:*),Bash(ls:*),Bash(diff:*),Bash(cp:*)"
